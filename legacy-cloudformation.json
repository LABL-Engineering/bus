{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Outputs": {},
	"Resources": {
		"LeoNewStream": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "event",
					"AttributeType": "S"
				}, {
					"AttributeName": "end",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "event",
					"KeyType": "HASH"
				}, {
					"AttributeName": "end",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "20",
					"WriteCapacityUnits": "20"
				},
				"TableName": "Leo_stream"
			}
		},
		"KinesisStream": {
			"Type": "AWS::Kinesis::Stream",
			"Properties": {
				"ShardCount": 1
			}
		},
		"FirehoseStream": {
			"Type": "AWS::KinesisFirehose::DeliveryStream",
			"Properties": {
				"S3DestinationConfiguration": {
					"BucketARN": {
						"Fn::Join": [
							"", [
								"arn:aws:s3:::", {
									"Ref": "S3Bus"
								}
							]
						]
					},
					"BufferingHints": {
						"IntervalInSeconds": 60,
						"SizeInMBs": 128
					},
					"Prefix": "firehose/",
					"CompressionFormat": "UNCOMPRESSED",
					"RoleARN": {
						"Fn::GetAtt": [
							"FirehoseRole",
							"Arn"
						]
					}
				}
			}
		},
		"LeoArchive": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "event",
					"AttributeType": "S"
				}, {
					"AttributeName": "end",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "event",
					"KeyType": "HASH"
				}, {
					"AttributeName": "end",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_archive"
			}
		},
		"Leo": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "event",
					"AttributeType": "S"
				}, {
					"AttributeName": "kinesis_number",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "event",
					"KeyType": "HASH"
				}, {
					"AttributeName": "kinesis_number",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "200",
					"WriteCapacityUnits": "200"
				},
				"StreamSpecification": {
					"StreamViewType": "NEW_IMAGE"
				},
				"TableName": "Leo"
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "704d8596-9847-40d8-a7c9-16f0f72da1de"
				}
			}
		},
		"LeoS3Index": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "queue",
					"AttributeType": "S"
				}, {
					"AttributeName": "end",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "queue",
					"KeyType": "HASH"
				}, {
					"AttributeName": "end",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "20",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_s3_index"
			}
		},
		"LeoStream": {
			"Type": "AWS::Kinesis::Stream",
			"Properties": {
				"ShardCount": 1
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "52becfcd-5402-4763-b6ba-baf715131e08"
				}
			}
		},
		"LeoCore": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"", [
								"var response = require('cfn-response');",
								"exports.handler = function(event, context) {",
								"  var input = parseInt(event.ResourceProperties.Input);",
								"  var responseData = {Value: input * 5};",
								"  response.send(event, context, response.SUCCESS, responseData);",
								"};"
							]
						]
					}
				},
				"Description": "Leo Core",
				"FunctionName": "Leo_core",
				"Handler": "index.handler",
				"MemorySize": 256,
				"Runtime": "nodejs4.3",
				"Timeout": 60,
				"Role": {
					"Fn::GetAtt": [
						"RoleLambdaKinesis",
						"Arn"
					]
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "5b899bac-9541-494b-a6a6-3bd84481490d"
				}
			},
			"DependsOn": [
				"Leo",
				"RoleLambdaKinesis"
			]
		},
		"LeoCoreEventSource": {
			"Type": "AWS::Lambda::EventSourceMapping",
			"Properties": {
				"BatchSize": 500,
				"Enabled": true,
				"StartingPosition": "TRIM_HORIZON",
				"EventSourceArn": {
					"Fn::GetAtt": [
						"LeoStream",
						"Arn"
					]
				},
				"FunctionName": {
					"Ref": "LeoCore"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "c81dba54-7b65-4872-a683-709ad8ad2833"
				}
			}
		},
		"LeoBot": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}, {
					"AttributeName": "event",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}, {
					"AttributeName": "event",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				},
				"TableName": "Leo_bot"
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "62497cab-58d4-40ca-8f52-a97e7abfe5fa"
				}
			}
		},
		"LeoEvent": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "event",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "event",
					"KeyType": "HASH"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_event",
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "8f993562-76d9-427f-8ede-c83b65ed9a36"
				}
			}
		},
		"ManagedLeoBotPolicy": {
			"Type": "AWS::IAM::ManagedPolicy",
			"Properties": {
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Action": [
							"kinesis:PutRecords",
							"kinesis:PutRecord"
						],
						"Resource": [{
							"Fn::GetAtt": [
								"KinesisStream",
								"Arn"
							]
						}, {
							"Fn::GetAtt": [
								"LeoStream",
								"Arn"
							]
						}]
					}, {
						"Effect": "Allow",
						"Action": [
							"firehose:PutRecord",
							"firehose:PutRecordBatch"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:firehose:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":deliverystream/", {
										"Ref": "BusToS3"
									}
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:Query"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:Query"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_stream"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"s3:GetObject"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									},
									"/bus/*"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"s3:GetObject"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									},
									"/bus_v2/*"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"s3:PutObject",
							"s3:GetObject"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									},
									"/files/*"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"s3:ListBucket"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									}
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:BatchGetItem",
							"dynamodb:BatchWriteItem",
							"dynamodb:UpdateItem",
							"dynamodb:PutItem",
							"dynamodb:DeleteItem"
						],
						"Resource": [{
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_bot"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_event"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_entities"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_setting"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_sla"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_cron"
								]
							]
						}]
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:Query",
							"dynamodb:Scan",
							"dynamodb:GetItem",
							"dynamodb:BatchGetItem"
						],
						"Resource": [{
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_setting"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_sla"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_stats*"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_cron_stats*"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_cron"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_event"
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_system"
								]
							]
						}]
					}, {
						"Effect": "Allow",
						"Action": [
							"ec2:CreateNetworkInterface",
							"ec2:DescribeNetworkInterfaces",
							"ec2:DetachNetworkInterface",
							"ec2:DeleteNetworkInterface"
						],
						"Resource": "*"
					}, {
						"Effect": "Allow",
						"Action": [
							"sns:Publish"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:sns:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":*"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"lambda:InvokeFunction"
						],
						"Resource": [{
							"Fn::GetAtt": [
								"KinesisStream",
								"Arn"
							]
						}, {
							"Fn::GetAtt": [
								"LeoStream",
								"Arn"
							]
						}]
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:GetRecords",
							"dynamodb:GetShardIterator",
							"dynamodb:DescribeStream",
							"dynamodb:ListStreams",
							"logs:CreateLogGroup",
							"logs:CreateLogStream",
							"logs:PutLogEvents"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo*"
								]
							]
						}
					}]
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "039cd135-ee5b-4305-b02a-7549f16850fc"
				}
			}
		},
		"RoleLeoInstall": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [{
					"Ref": "Authorizer"
				}],
				"Policies": []
			}
		},
		"RoleLambdaKinesis": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}
				],
				"Policies": [{
					"PolicyName": "Leo_core",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"kinesis:DescribeStream",
								"kinesis:GetRecords",
								"kinesis:GetShardIterator",
								"kinesis:ListStreams"
							],
							"Resource": [{
								"Fn::GetAtt": [
									"LeoStream",
									"Arn"
								]
							}, {
								"Fn::GetAtt": [
									"KinesisStream",
									"Arn"
								]
							}]
						}, {
							"Effect": "Allow",
							"Action": [
								"s3:PutObject"
							],
							"Resource": [{
								"Fn::Join": [
									"", [
										"arn:aws:s3:::", {
											"Ref": "S3Bus"
										}
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:s3:::", {
											"Ref": "S3Bus"
										},
										"/*"
									]
								]
							}]
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:PutItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:BatchGetItem",
								"dynamodb:GetRecords",
								"dynamodb:UpdateItem",
								"dynamodb:Query",
								"dynamodb:GetShardIterator",
								"dynamodb:DescribeStream",
								"dynamodb:ListStreams"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo*"
									]
								]
							}
						}]
					}
				}]
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "079fef9c-e27a-49a3-ac6c-3244f2676bf1"
				}
			},
			"DependsOn": [
				"LeoStream",
				"KinesisStream"
			]
		},
		"RoleLeoBot": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}, {
						"Ref": "Authorizer"
					}
				],
				"Policies": []
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "85169e9f-9723-42c6-80e3-e4d342551072"
				}
			}
		},
		"BusToS3": {
			"Type": "AWS::KinesisFirehose::DeliveryStream",
			"Properties": {
				"S3DestinationConfiguration": {
					"BucketARN": {
						"Fn::Join": [
							"", [
								"arn:aws:s3:::", {
									"Ref": "S3Bus"
								}
							]
						]
					},
					"BufferingHints": {
						"IntervalInSeconds": 60,
						"SizeInMBs": 128
					},
					"Prefix": "ingest/",
					"CompressionFormat": "GZIP",
					"RoleARN": {
						"Fn::GetAtt": [
							"FirehoseRole",
							"Arn"
						]
					}
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "f501ed53-6034-4852-8006-52aa3ad4c033"
				}
			}
		},
		"S3Bus": {
			"Type": "AWS::S3::Bucket",
			"Properties": {},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "d3b849ed-6242-4fc5-81ef-3d870d51543a"
				}
			}
		},
		"FirehoseRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": "firehose.amazonaws.com"
						},
						"Action": "sts:AssumeRole",
						"Condition": {
							"StringEquals": {
								"sts:ExternalId": {
									"Ref": "AWS::AccountId"
								}
							}
						}
					}, {
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
				],
				"Policies": [{
					"PolicyName": "Leo_Bus_firehose",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"s3:AbortMultipartUpload",
								"s3:GetBucketLocation",
								"s3:GetObject",
								"s3:ListBucket",
								"s3:ListBucketMultipartUploads",
								"s3:PutObject"
							],
							"Resource": [{
								"Fn::Join": [
									"", [
										"arn:aws:s3:::", {
											"Ref": "S3Bus"
										}
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:s3:::", {
											"Ref": "S3Bus"
										},
										"/*"
									]
								]
							}]
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:PutItem",
								"dynamodb:GetItem",
								"dynamodb:UpdateItem",
								"dynamodb:BatchGetItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:GetRecords"
							],
							"Resource": [{
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_setting"
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_event"
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_s3_index"
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_stream"
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_bot"
									]
								]
							}]
						}]
					}
				}]
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "5d286bc4-0d9b-4b3b-9e9d-d0bc1601bbc8"
				}
			}
		},
		"BusApi": {
			"Type": "AWS::ApiGateway::RestApi",
			"Properties": {
				"Name": "Leo_Core"
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "2b8ee792-1cde-4545-a561-439b2513cdd9"
				}
			}
		},
		"FirehoseManagedPolicy": {
			"Type": "AWS::IAM::ManagedPolicy",
			"Properties": {
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Action": [
							"firehose:PutRecord",
							"firehose:PutRecordBatch"
						],
						"Resource": [{
							"Fn::Join": [
								"", [
									"arn:aws:firehose:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":deliverystream/", {
										"Ref": "BusToS3"
									}
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:firehose:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":deliverystream/", {
										"Ref": "FirehoseStream"
									}
								]
							]
						}]
					}, {
						"Effect": "Allow",
						"Action": [
							"s3:GetObject",
							"s3:ListBucket",
							"s3:PutObject"
						],
						"Resource": [{
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									}
								]
							]
						}, {
							"Fn::Join": [
								"", [
									"arn:aws:s3:::", {
										"Ref": "S3Bus"
									},
									"/*"
								]
							]
						}]
					}]
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "1ffa4f1b-f8e4-4264-aa14-95e88ab2d2c1"
				}
			}
		},
		"LeoSettings": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_setting"
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "b2f61e05-b805-4ea7-ae02-c86cf49ddf6b"
				}
			}
		},
		"Authorizer": {
			"Type": "AWS::IAM::ManagedPolicy",
			"Properties": {
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Action": [
							"dynamodb:BatchGetItem",
							"dynamodb:GetItem"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_auth"
								]
							]
						}
					}, {
						"Effect": "Allow",
						"Action": [
							"dynamodb:GetItem"
						],
						"Resource": {
							"Fn::Join": [
								"", [
									"arn:aws:dynamodb:", {
										"Ref": "AWS::Region"
									},
									":", {
										"Ref": "AWS::AccountId"
									},
									":table/Leo_auth_user"
								]
							]
						}
					}]
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "21d332e2-b765-45a5-bbe4-5c3c66d060cb"
				}
			}
		},
		"LeoLog": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}, {
					"AttributeName": "ts",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}, {
					"AttributeName": "ts",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_Log"
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "b4dc100a-851e-42a0-b261-72d00e984223"
				}
			}
		},
		"LeoEntities": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "5",
					"WriteCapacityUnits": "5"
				},
				"TableName": "Leo_entities",
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "8895cde6-5a53-4d8d-a2b3-0dfe220487d6"
				}
			}
		},
		"LeoEntityChangeTracker": {
			"Type": "AWS::Lambda::EventSourceMapping",
			"Properties": {
				"BatchSize": 300,
				"Enabled": true,
				"StartingPosition": "TRIM_HORIZON",
				"EventSourceArn": {
					"Fn::GetAtt": [
						"LeoEntities",
						"StreamArn"
					]
				},
				"FunctionName": {
					"Ref": "ProcessEntityChange"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "2c9d0fdd-f326-4899-b8f5-fe112415dd98"
				}
			}
		},
		"ProcessEntityChange": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"", [
								"var response = require('cfn-response');",
								"exports.handler = function(event, context) {",
								"  var input = parseInt(event.ResourceProperties.Input);",
								"  var responseData = {Value: input * 5};",
								"  response.send(event, context, response.SUCCESS, responseData);",
								"};"
							]
						]
					}
				},
				"Description": "Leo Core Entity Watch",
				"FunctionName": "Leo_core_entity_watch",
				"Handler": "index.handler",
				"MemorySize": 384,
				"Runtime": "nodejs4.3",
				"Timeout": 120,
				"Role": {
					"Fn::GetAtt": [
						"RoleLambdaKinesis",
						"Arn"
					]
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "d1013530-7485-4f57-a99c-9d29914ae49c"
				}
			}
		},
		"DeveloperGroup": {
			"Type": "AWS::IAM::Group",
			"Properties": {
				"ManagedPolicyArns": [{
					"Ref": "ManagedLeoBotPolicy"
				}],
				"Policies": [{
					"PolicyName": "Leo_developer",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": "sts:AssumeRole",
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":role/Leo*"
									]
								]
							}
						}]
					}
				}]
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "449097a9-25be-48a5-8330-710824531dc9"
				}
			}
		},
		"LeoElasticSearchRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}
				],
				"Policies": [{
					"PolicyName": "Leo_elasticsearch",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"es:ESHttpGet",
								"es:ESHttpPost"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:es:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":domain/*"
									]
								]
							}
						}]
					}
				}]
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "b787931f-72b9-4a5e-ad83-74190b3d5ea1"
				}
			}
		},
		"LeoChecksumRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}
				],
				"Policies": [{
					"PolicyName": "Leo_checksum",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"dynamodb:Scan",
								"dynamodb:PutItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:BatchGetItem",
								"dynamodb:GetRecords",
								"dynamodb:UpdateItem",
								"dynamodb:Query",
								"dynamodb:GetShardIterator",
								"dynamodb:DescribeStream",
								"dynamodb:ListStreams"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_cron*"
									]
								]
							}
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:Scan",
								"dynamodb:PutItem",
								"dynamodb:GetItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:BatchGetItem",
								"dynamodb:GetRecords",
								"dynamodb:UpdateItem",
								"dynamodb:Query",
								"dynamodb:GetShardIterator",
								"dynamodb:DescribeStream",
								"dynamodb:ListStreams"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_system*"
									]
								]
							}
						}, {
							"Effect": "Allow",
							"Action": [
								"lambda:InvokeFunction"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:lambda:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":function:*"
									]
								]
							}
						}]
					}
				}]
			}
		},
		"LeoCronRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}
				],
				"Policies": [{
					"PolicyName": "Leo_cron",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"dynamodb:Scan",
								"dynamodb:PutItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:BatchGetItem",
								"dynamodb:GetRecords",
								"dynamodb:UpdateItem",
								"dynamodb:Query",
								"dynamodb:GetShardIterator",
								"dynamodb:DescribeStream",
								"dynamodb:ListStreams"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_cron*"
									]
								]
							}
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:Scan",
								"dynamodb:BatchGetItem",
								"dynamodb:GetItem",
								"dynamodb:GetRecords",
								"dynamodb:Query",
								"dynamodb:GetShardIterator",
								"dynamodb:DescribeStream",
								"dynamodb:ListStreams"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_system*"
									]
								]
							}
						}, {
							"Effect": "Allow",
							"Action": [
								"lambda:InvokeFunction"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:lambda:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":function:*"
									]
								]
							}
						}, {
							"Effect": "Allow",
							"Action": [
								"states:ListExecutions",
								"states:StartExecution",
								"states:CreateStateMachine"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:states:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":stateMachine:*"
									]
								]
							}
						}]
					}
				}]
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "be4d0dfb-42b9-4bed-8b3b-5aa32a54db24"
				}
			}
		},
		"LeoCronStats": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}, {
					"AttributeName": "bucket",
					"AttributeType": "S"
				}, {
					"AttributeName": "period",
					"AttributeType": "S"
				}, {
					"AttributeName": "time",
					"AttributeType": "N"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}, {
					"AttributeName": "bucket",
					"KeyType": "RANGE"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "20",
					"WriteCapacityUnits": "20"
				},
				"GlobalSecondaryIndexes": [{
					"IndexName": "period-time-index",
					"KeySchema": [{
						"AttributeName": "period",
						"KeyType": "HASH"
					}, {
						"AttributeName": "time",
						"KeyType": "RANGE"
					}],
					"Projection": {
						"ProjectionType": "INCLUDE",
						"NonKeyAttributes": ["current"]
					},
					"ProvisionedThroughput": {
						"ReadCapacityUnits": "20",
						"WriteCapacityUnits": "20"
					}
				}],
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				},
				"TableName": "Leo_cron_stats"
			}
		},
		"LeoCronTable": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "20",
					"WriteCapacityUnits": "20"
				},
				"TableName": "Leo_cron",
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "3eb1cdc4-9303-4df0-a497-f265c4476ddc"
				}
			}
		},
		"LeoSystem": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [{
					"AttributeName": "id",
					"AttributeType": "S"
				}],
				"KeySchema": [{
					"AttributeName": "id",
					"KeyType": "HASH"
				}],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": "40",
					"WriteCapacityUnits": "20"
				},
				"TableName": "Leo_system",
				"StreamSpecification": {
					"StreamViewType": "NEW_AND_OLD_IMAGES"
				}
			},
			"Metadata": {
				"AWS::CloudFormation::Designer": {
					"id": "400e75b8-c1b1-4a3b-85eb-cd65851cccca"
				}
			}
		},
		"LeoHealthCheckSNS": {
			"Type": "AWS::SNS::Topic",
			"Properties": {
				"DisplayName": "Leo Health Check",
				"TopicName": "LeoHealthCheck"
			}
		},
		"LeoHealthCheckRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole", {
						"Ref": "ManagedLeoBotPolicy"
					}
				],
				"Policies": [{
					"PolicyName": "Leo_helath_SNS",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"sns:Publish"
							],
							"Resource": {
								"Fn::Join": [
									"", [
										"arn:aws:sns:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":LeoHealthCheck"
									]
								]
							}
						}]
					}
				}]
			}
		},
		"ReadRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							],
							"AWS": {
								"Fn::Join": [
									"", [
										"arn:aws:iam::", {
											"Ref": "AWS::AccountId"
										},
										":root"
									]
								]
							}
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"Policies": [{
					"PolicyName": "Leo_micro_logging_to_analytics",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": [
								"kinesis:DescribeStream",
								"kinesis:GetRecords",
								"kinesis:GetShardIterator"
							],
							"Resource": [{
								"Fn::GetAtt": [
									"Logging",
									"Arn"
								]
							}]
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:BatchGetItem",
								"dynamodb:BatchWriteItem",
								"dynamodb:UpdateItem"
							],
							"Resource": [{
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_stats"
									]
								]
							}, {
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_cron_stats"
									]
								]
							}]
						}, {
							"Effect": "Allow",
							"Action": [
								"dynamodb:DeleteItem"
							],
							"Resource": [{
								"Fn::Join": [
									"", [
										"arn:aws:dynamodb:", {
											"Ref": "AWS::Region"
										},
										":", {
											"Ref": "AWS::AccountId"
										},
										":table/Leo_setting"
									]
								]
							}]
						}]
					}
				}],
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
				]
			}
		},
		"LoggingRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Statement": {
						"Action": "sts:AssumeRole",
						"Effect": "Allow",
						"Principal": {
							"Service": {
								"Fn::Join": [
									"", [
										"logs.", {
											"Ref": "AWS::Region"
										},
										".amazonaws.com"
									]
								]
							}
						}
					}
				},
				"Policies": [{
					"PolicyName": "Leo_Logging",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Effect": "Allow",
							"Action": "kinesis:PutRecord",
							"Resource": {
								"Fn::GetAtt": [
									"Logging",
									"Arn"
								]
							}
						}]
					}
				}]
			}
		},
		"Logging": {
			"Type": "AWS::Kinesis::Stream",
			"Properties": {
				"ShardCount": 1
			}
		},
		"ParseLogs": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"ZipFile": {
						"Fn::Join": [
							"", [
								"var response = require('cfn-response');",
								"exports.handler = function(event, context) {",
								"  var input = parseInt(event.ResourceProperties.Input);",
								"  var responseData = {Value: input * 5};",
								"  response.send(event, context, response.SUCCESS, responseData);",
								"};"
							]
						]
					}
				},
				"Description": "Leo Core parse cloudwatch logs",
				"FunctionName": "Leo_core_parse_logs",
				"Handler": "index.handler",
				"MemorySize": 384,
				"Runtime": "nodejs4.3",
				"Timeout": 300,
				"Role": {
					"Fn::GetAtt": [
						"ReadRole",
						"Arn"
					]
				}
			},
			"DependsOn": [
				"LeoCronStats"
			]
		},
		"ParseLogsEventSource": {
			"Type": "AWS::Lambda::EventSourceMapping",
			"Properties": {
				"BatchSize": 500,
				"Enabled": true,
				"StartingPosition": "LATEST",
				"EventSourceArn": {
					"Fn::GetAtt": [
						"Logging",
						"Arn"
					]
				},
				"FunctionName": {
					"Ref": "ParseLogs"
				}
			}
		}
	}
}